<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>P1471 方差</title>
  <link rel="stylesheet" href="../style.css">
  <script defer src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
</head>
<body>
  <div class="wrap">

    <div class="post-topbar">
      <a class="back-link" href="../index.html">← back</a>

      <button class="theme-btn" id="themeBtn" type="button">
        <span class="theme-txt">Dark</span>
      </button>
    </div>

    <h1>P1471 方差</h1>
    <p>題目來源：洛谷 P1471 方差</p>
    <p>題目：N 個數 其中第 i 個數表示數列的第 i 項 接下來 M 行 每行為一條操作 格式為以下三種：</p>
    <p>操作 1：1 x y k 表示將第 x 到第 y 項加上 k</p>
    <p>操作 2：2 x y 表示求第 x 到第 y 項這數列的平均數</p>
    <p>操作 3：3 x y 表示求第 x 到第 y 項這數列的變異數</p>
    <br>
<p>
變異數的公式是 \( \frac{1}{n}\sum_{i=1}^{n}\left(A_i-\overline{A}\right)^2 \)
可以化簡成 \( \frac{a_1^2+a_2^2+\cdots+a_n^2}{n}-\overline{a}^{\,2} \)
所以每個點只需要記錄 sum 和 sum of square
但如果要算平方數的和 那就沒辦法用懶惰標記
update 的時間就會變成 \(O(n)\)
所以要簡化 \( \sum_{i=1}^{n}(a_i+k)^2 \)
成 \( \sum_{i=1}^{n} a_i^2 + 2k\sum_{i=1}^{n} a_i + nk^2 \)
</p>

    <p></p>
    <p></p>
    <p></p>
    <br>
    <p>初始線段樹：</p>
    

<pre><code class="language-cpp">int const c=1e5+1;
vector&lt;double&gt; a(c);
  
struct node{
   int l,r;
   double sum,sqrsum,add;
}tree[c*4];
  
void pushup(int pos){
   int l=pos*2,r=pos*2+1;
   tree[pos].sum=tree[l].sum+tree[r].sum;
   tree[pos].sqrsum=tree[l].sqrsum+tree[r].sqrsum;
}
  
void build(int pos, int l, int r){
   tree[pos]={l,r,a[l],a[l]*a[l],0};
   if(l==r)return;
   int mid=r+l&gt;&gt;1;
   build(pos*2,l,mid);
   build(pos*2+1,mid+1,r);
   pushup(pos);
}</code></pre>

    <br>
    <p>區間更新：</p>
<pre><code class="language-cpp">void update(int pos, int l, int r, double k){
   if(l&lt;=tree[pos].l &amp;&amp; tree[pos].r&lt;=r){
       tree[pos].sqrsum+=2*k*(tree[pos].sum)+k*k*(tree[pos].r-tree[pos].l+1);
       tree[pos].sum+=(tree[pos].r-tree[pos].l+1)*k;
       tree[pos].add+=k;
       return;
   }
   int mid=tree[pos].l+tree[pos].r&gt;&gt;1;
   pushdown(pos);
   if(l&lt;=mid)update(pos*2,l,r,k);
   if(r&gt;mid)update(pos*2+1,l,r,k);
   pushup(pos);
}</code></pre>

    <br>
    <p>區間查詢：</p>
<pre><code class="language-cpp">double querysum(int pos, int l, int r){
   if(l&lt;=tree[pos].l &amp;&amp; tree[pos].r&lt;=r)return tree[pos].sum;
   int mid=tree[pos].l+tree[pos].r&gt;&gt;1;
   pushdown(pos);
   double sum=0;
   if(l&lt;=mid)sum+=querysum(pos*2,l,r);
   if(r&gt;mid)sum+=querysum(pos*2+1,l,r);
   return sum;
}
  
double querysqrsum(int pos, int l, int r){
   if(l&lt;=tree[pos].l &amp;&amp; tree[pos].r&lt;=r)return tree[pos].sqrsum;
   int mid=tree[pos].l+tree[pos].r&gt;&gt;1;
   pushdown(pos);
   double sum=0;
   if(l&lt;=mid)sum+=querysqrsum(pos*2,l,r);
   if(r&gt;mid)sum+=querysqrsum(pos*2+1,l,r);
   return sum;
}</code></pre>
    <br>
    <p>操作 1 ：</p>
<pre><code class="language-cpp">int x,y;cin&gt;&gt;x&gt;&gt;y;
double k;cin&gt;&gt;k;
update(1,x,y,k);</code></pre>

    
    <br>
    <p>操作 2 ：</p>
<pre><code class="language-cpp">int x,y;cin&gt;&gt;x&gt;&gt;y;
cout&lt;&lt;fixed&lt;&lt;setprecision(4)&lt;&lt;(double)querysum(1,x,y)/(y-x+1)&lt;&lt;'\n';</code></pre>

    <br>
    <p>操作 3 ：</p>
<pre><code class="language-cpp">int x,y;cin&gt;&gt;x&gt;&gt;y;
double avgsqrsum=querysqrsum(1,x,y)/(y-x+1);
double avgsum=querysum(1,x,y)/(y-x+1);
cout&lt;&lt;fixed&lt;&lt;setprecision(4)&lt;&lt;avgsqrsum-pow(avgsum,2)&lt;&lt;'\n';</code></pre>


  </div>

  <script src="../script.js"></script>
</body>
</html>
